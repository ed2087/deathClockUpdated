document.addEventListener("DOMContentLoaded",function(){const e=id_("commentForm"),t=id_("commentText"),o=id_("comments"),n=id_("storyId_cooments").value,r=id_("csrf_comments").value,s=id_("userId_cooments").value;let a=!1;const c=(e,t)=>{const o=new Date(e.createdAt),n=o.toLocaleDateString(),r=o.toLocaleTimeString();if(t.innerHTML+=`\n        <div class="comment_wrap" id="comment_W${e._id}">\n\n          <div class="inner_commentWrap">\n\n                <div class="comment_header">\n                  <p><span class="message_specialCH">@</span>${e.userName} <span class="message_specialCH">·</span> ${n} <span class="message_specialCH">·</span> ${r}</p>\n                </div>\n\n                <div class="comment_text">${e.commentText}</div>\n\n                <div class="comment_buttonWrap">\n                  ${""!==s?`<button class="reply" data-id="${e._id}" id="replyBTN_${e._id}">Reply</button>`:""}\n                  ${e.userId===s?`<button class="delete" data-id="${e._id}" id="deleteBTN_${e._id}">Delete</button>`:""}\n                </div>\n\n                <div class="reply_formOutter_wrap" id="replyForm_${e._id}"></div>\n\n          </div>\n\n          <div class="replies" id="replies_${e._id}"></div>\n\n        </div>\n      `,!1!==a){const t=id_("comment_W"+e._id);t.scrollIntoView({behavior:"smooth",block:"center"})}const c=document.querySelectorAll(".reply");c.forEach(e=>{e.addEventListener("click",l)});const d=document.querySelectorAll(".delete");d.forEach(e=>{e.addEventListener("click",m)})},l=e=>{const t=e.target.getAttribute("data-id");if(void 0===s)return void alert("Please login to reply to a comment");const o=`\n        <form class="reply_form" data-parentId="${t}" id="replyForm_${t}">\n          <textarea name="replyText" id="replyText_W${t}" placeholder="Reply To Comment" required></textarea>\n          <button type="submit" style="color:green;">Reply</button>\n        </form>\n      `,n=id_("replyForm_"+t);n.innerHTML+=o,id_("replyBTN_"+t).style.display="none";const r=id_("replyForm_"+t);r.addEventListener("submit",d);const a=id_("replyText_W"+t);a.focus()},d=async e=>{e.preventDefault();const t=e.target.replyText.value,o=e.target.getAttribute("data-parentId");try{const a=await fetch(`/storyReplyMessage/${n}`,{method:"POST",headers:{"Content-Type":"application/json","CSRF-Token":r},body:JSON.stringify({userId:s,replyText:t,parentCommentId:o})});a.ok||(alert("Please login to reply to a comment"),console.log(a,"response"));const d=await a.json();c(d,id_("replies_"+o)),id_("replyBTN_"+o).style.display="block",e.target.remove();const i=document.querySelectorAll(".reply");i.forEach(e=>{e.addEventListener("click",l)})}catch(e){console.error("Error adding reply:",e.message)}},i=async e=>{e.preventDefault();const a=t.value;try{const e=await fetch(`/StoryTopLevelMessage/${n}`,{method:"POST",headers:{"Content-Type":"application/json","CSRF-Token":r},body:JSON.stringify({userId:s,commentText:a,csrf:r})});if(!e.ok)throw new Error(`Failed to add top-level comment. Status: ${e.status}`);const l=await e.json();t.value="",c(l,o)}catch(e){console.error("Error adding top-level comment:",e.message)}},m=async e=>{const t=e.target.getAttribute("data-id");try{const e=await fetch(`/storyMessage/${t}`,{method:"DELETE",headers:{"Content-Type":"application/json","CSRF-Token":r},body:JSON.stringify({userId:s})});e.ok||(alert("Error deleting comment or reply"),console.log(e,"response"));const o=id_("comment_W"+t);o.remove()}catch(e){console.error("Error deleting comment or reply:",e.message)}};if(null!==document.querySelectorAll(".delete")){const e=document.querySelectorAll(".delete");e.forEach(e=>{e.addEventListener("click",m)})}const p=async()=>{try{const e=await fetch(`/storyComments/${n}`);e.ok||(console.error(`Failed to fetch comments. Status: ${e.status}`),alert("Failed to fetch comments. Please try again later."));const t=await e.json();let r=[];t.forEach(e=>{null===e.parentCommentId?c(e,o):r.push(e)}),r.forEach(e=>{const t=id_("replies_"+e.parentCommentId);c(e,t)});const s=document.querySelectorAll(".reply");s.forEach(e=>{e.addEventListener("click",l)}),a=!0}catch(e){console.error("Error fetching comments:",e.message)}};console.log(s,"userID"),""!==s&&e.addEventListener("submit",i),p()});